version: 2

models:
  # ------------------------
  # STAGING MODELS
  # ------------------------
  - name: staging_acceptance
    description: Cleaned and standardized version of the acceptance table with additional fields such as amount in USD.
    columns:
      - name: external_ref
        data_type: STRING
        description: External unique identifier for the payment transaction.
        tests:
          - unique
          - not_null

      - name: status
        data_type: BOOLEAN
        description: Current status of the payment (TRUE, FALSE).
        tests:
          - not_null

      - name: source
        data_type: STRING
        description: System or channel from which the payment originated.
        tests:
          - not_null

      - name: ref
        data_type: STRING
        description: Transaction reference code.
        tests:
          - not_null

      - name: date_time
        data_type: TIMESTAMP
        description: Timestamp when the payment occurred, converted to TIMESTAMP type.
        tests:
          - not_null

      - name: state
        data_type: STRING
        description: Internal state of the payment during processing (ACCEPTED, DECLINED)
        tests:
          - not_null

      - name: cvv_provided
        data_type: BOOLEAN
        description: Indicator if CVV was provided by the customer during the transaction.
        tests:
          - not_null

      - name: local_curr_amount
        data_type: NUMERIC
        description: Payment amount in the original transaction currency.
        tests:
          - not_null

      - name: country
        data_type: STRING
        description: Country where the payment originated (2 char ISO Code).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: "^[A-Z]{2}$"

      - name: currency
        data_type: STRING
        description: Original currency code for the transaction (e.g. EUR, GBP, USD).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: "^[A-Z]{3}$"

      - name: rates
        data_type: STRING # We should change this to JSON with more time
        description: JSON string of currency conversion rates where USD=1.
        tests:
          - not_null

      - name: amount_usd
        data_type: NMERIC
        description: Payment amount converted to USD using the rate data in the rates column.
        tests:
          - not_null

  - name: staging_chargeback
    description: Cleaned and standardized version of the chargeback table.
    columns:
      - name: external_ref
        data_type: STRING
        description: External unique identifier matching the payment in the acceptance table.
        tests:
          - unique
          - not_null

      - name: status
        data_type: BOOLEAN
        description: Internal state of the processing of the chargeback (TRUE, FALSE).
        tests:
          - not_null

      - name: source
        data_type: STRING
        description: System or channel from which the chargeback originated.
        tests:
          - not_null

      - name: chargeback
        data_type: BOOLEAN
        description: State of whether the chargeback was processed successfuly (TRUE, FALSE).
        tests:
          - not_null

  # ------------------------
  # ANALYTICS MODEL
  # ------------------------
  - name: payment_acceptance
    description: Combined dataset joining acceptance and chargeback records, including chargeback flag.
    columns:
      - name: external_ref
        data_type: STRING
        description: Unique payment identifier joining acceptance and chargeback records.
        tests:
          - unique
          - not_null

      - name: status
        data_type: BOOLEAN
        description: Status of the original payment (TRUE, FALSE).

      - name: source
        data_type: STRING
        description: Payment channel or system source.

      - name: ref
        data_type: STRING
        description: Transaction reference code.

      - name: date_time
        data_type: TIMESTAMP
        description: Timestamp of the payment attempt.

      - name: state
        data_type: STRING
        description: Internal payment state (ACCEPTED, DECLINED).

      - name: cvv_provided
        data_type: BOOLEAN
        description: Indicator if CVV was provided during payment.

      - name: amount_usd
        data_type: NUMERIC
        description: Payment amount converted to USD for unified financial reporting.

      - name: country
        data_type: STRING
        description: Country of the payer.

      - name: currency
        data_type: STRING
        description: Original transaction currency.

      - name: chargeback_processed
        data_type: BOOLEAN
        description: State of whether the chargeback was processed successfuly (TRUE, FALSE).

      - name: chargeback_accepted
        data_type: BOOLEAN
        description: Boolean flag indicating if the chargeback was accepted.

  - name: acceptance_by_country
    description: Aggregated payment acceptance metrics broken down by country, including total volume, transaction counts, and acceptance rates.
    columns:
      - name: country
        data_type: STRING
        description: The two-letter country code of the payment.

      - name: total_volume_usd
        data_type: NUMERIC
        description: Total aggregated volume (Accepted + Declined) for the country, in USD.
        tests:
          - not_null

      - name: total_transactions
        data_type: INTEGER
        description: Total count of all transactions (Accepted + Declined) for the country.
        tests:
          - not_null

      - name: accepted_transactions
        data_type: INTEGER
        description: Count of transactions where state was 'ACCEPTED'.
        tests:
          - not_null

      - name: accepted_volume_usd
        data_type: NUMERIC
        description: Total USD volume of transactions where state was 'ACCEPTED'.
        tests:
          - not_null

      - name: declined_transactions
        data_type: INTEGER
        description: Count of transactions where state was 'DECLINED'.
        tests:
          - not_null

      - name: declined_volume_usd
        data_type: NUMERIC
        description: Total USD volume of transactions where state was 'DECLINED'.
        tests:
          - not_null

      - name: acceptance_rate
        data_type: FLOAT
        description: Transaction-level acceptance rate (Accepted Transactions / Total Transactions). Value is between 0 and 1.
        tests:
          - not_null

      - name: volume_acceptance_rate
        data_type: NUMERIC
        description: Volume-level acceptance rate (Accepted Volume / Total Volume). Value is between 0 and 1.
        tests:
          - not_null

  - name: acceptance_rate_over_time
    description: Monthly time series of payment acceptance metrics, including total volume, transaction counts, and acceptance rates, calculated in USD.
    columns:
      - name: payment_month
        data_type: DATE
        description: The month for the aggregation period. This is the primary time dimension.
        tests:
          - not_null
          - unique # Ensure each month appears only once (acting as a primary key)

      - name: total_amount_usd
        data_type: NUMERIC
        description: Total aggregated payment volume (Accepted + Declined) for the month, in USD.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: accepted_amount_usd
        data_type: NUMERIC
        description: Total USD volume of successfully accepted payments for the month.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: declined_amount_usd
        data_type: NUMERIC
        description: Total USD volume of declined payments for the month.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0 

      - name: total_transactions
        data_type: INT64 # Or BIGINT
        description: Total count of all payment attempts for the month.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1

      - name: accepted_transactions
        data_type: INT64 # Or BIGINT
        description: Count of successfully accepted transactions.
        tests:
          - not_null

      - name: declined_transactions
        data_type: INT64 # Or BIGINT
        description: Count of declined transactions.
        tests:
          - not_null

      - name: transaction_acceptance_rate
        data_type: FLOAT64
        description: Transaction-level acceptance rate. Percentage value (0.00 to 100.00) calculated as (Accepted Transactions / Total Transactions) * 100.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 100

      - name: transaction_declined_rate
        data_type: FLOAT64
        description: Transaction-level decline rate. Percentage value (0.00 to 100.00) calculated as (Declined Transactions / Total Transactions) * 100.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 100

  - name: high_decline_countries
    description: A list of countries where the total volume of declined transactions (in USD) exceeded a threshold of $25 Million. Useful for highlighting regions with significant acceptance issues.
    columns:
      - name: country
        data_type: STRING
        description: The two-letter country code. This serves as the unique identifier.
        tests:
          - not_null
          - unique

      - name: declined_volume_usd
        data_type: NUMERIC
        description: The total volume of transactions that were declined in this country (in USD).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 25000000 # Enforces the business logic

      - name: total_volume_usd
        data_type: NUMERIC
        description: The total gross volume (Accepted + Declined) for the country (in USD).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0